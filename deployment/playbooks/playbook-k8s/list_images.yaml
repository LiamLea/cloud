- hosts: localhost
  gather_facts: True
  tasks:
  - name: install kubeadm
    apt:
      name: "kubeadm={{ kubernetes.version }}-00"
      state: present
      update_cache: yes
  - name: get k8s images
    shell: "kubeadm config images list --kubernetes-version={{ kubernetes.version}} --image-repository={{ kubernetes.repository }}"
    register: result1

  - name: include vars
    include_vars:
      dir: roles/k8s/defaults
  - name: select calico version
    set_fact:
      result: "{% for c_v in calico_k8s %} {% for k_v in calico_k8s[c_v]['k8s'] %} {% if k_v in kubernetes.version %} {{ c_v }} {% endif %} {% endfor %}{% endfor %}"
  - name: select calico version
    set_fact:
      calico_version: "{{ result | trim }}"

  - name: include template prometheus
    include_tasks: roles/prometheus/tasks/template_prometheus.yaml

  - name: include template elastic
    include_tasks: roles/elastic/tasks/template_elastic.yaml

  - name: set images
    set_fact:
      my_dict:
        k8s: "{{ result1.stdout.split('\n') }}"
        others:
        - "{{ nginx.image }}"
        - "{{ keepalived.image }}"
        - "{{ docker.containerd.sandbox_image }}"
        calico: "{{ calico_k8s[calico_version]['images'] }}"
        prometheus: "{{ prometheus_images | union }}"
        elastic: "{{ elastic_images | union }}"

  - name: list_images
    debug:
      msg: "{{ my_dict }}"
